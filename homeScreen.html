<!DOCTYPE html>
<html>

<head>
    <title>TD Shop</title>
    <link href="css/index.css" rel="stylesheet">
    <script src="index.js" type="module"></script>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="homeScreen.html"><img src="images/shop.webp" alt="TD Shop" class="logo">TD
                    Shop</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="nav-align" id="navbarSupportedContent">
                    <form id="searchForm" class="d-flex">
                        <input id="searchInput" class="form-control me-2" type="search" placeholder="Search"
                            aria-label="Search">
                        <button class="myButton fancyButton" type="submit">Search</button>
                    </form>
                    <div class="dropdown" style="float:right;">
                        <button class="btn btn-light" id="dropdown-button">USER</button>
                        <div class="dropdown-content" id="dropdown-content">
                            <a href="profileScreen.html">Profile Tab</a>
                            <a href="loginScreen.html">Logout</a> <!-- need to clear cart in local (all local storage too), user info-->
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div id="products">
            <div class="product">
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                <script src="js/cart.js"></script>
                <script>
                    var products = [];

                    $(document).ready(function () {

                        // Check the login status
                        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                        const dropdownContent = document.getElementById('dropdown-content');
                        dropdownContent.innerHTML = '';
                        if (isLoggedIn) {
                            // If the user is logged in, show the profile tab and the logout button
                            dropdownContent.innerHTML += '<a href="#">Profile Tab</a>';
                            dropdownContent.innerHTML += '<a href="#" id="logout">Logout</a>';
                        } else {
                            // If the user is not logged in, show the login button
                            dropdownContent.innerHTML += '<a href="loginScreen.html">Log In</a>';
                        }

                        // Add a click event listener to the logout button
                        const logoutButton = document.getElementById('logout');
                        if (logoutButton) {
                            logoutButton.addEventListener('click', function () {
                                // Clear the login status
                                localStorage.removeItem('isLoggedIn');
                                clearCart();
                                // Refresh the page
                                location.reload();
                            });
                        }

                        $.ajax({
                            url: "index.php",
                            type: "GET",
                            dataType: "json",
                            success: function (data) {
                                products = data;
                                console.log(products);
                                updateProductList(products); // Call your function to display the products
                            },
                            error: function (error) {
                                console.log("Error: ", error);
                            }
                        });
                    });

                    function updateProductList(products) {
                        const productsSection = document.getElementById('products');
                        productsSection.innerHTML = '';
                        products.forEach(addProductToPage);
                    }

                    function addProductToPage(product) {
                        var productsSection = document.getElementById('products');

                        var productDiv = document.createElement('div');
                        productDiv.className = 'card-flex'; // Add the 'card-flex' class to the productDiv

                        var productLink = document.createElement('a');
                        productLink.href = `productScreen.html?id=${product.id}`;

                        var productImage = document.createElement('img');
                        productImage.src = product.image;
                        productImage.className = 'img-fit'; // Add the 'img-fit' class to the productImage
                        productLink.appendChild(productImage);
                        productDiv.appendChild(productLink);

                        var productNameLink = document.createElement('a');
                        productNameLink.href = `productScreen.html?id=${product.id}`;

                        var productName = document.createElement('h2'); // Change 'product-title' to 'h2'
                        productName.textContent = product.name;
                        productName.id = 'product-title';
                        productName.className = 'product-title'; // Add the 'title' class to the productName
                        productNameLink.appendChild(productName);
                        productDiv.appendChild(productNameLink);

                        var productDescription = document.createElement('p'); // Change 'productDescription' to 'p'
                        productDescription.textContent = product.description;
                        productDescription.id = 'product-description';
                        productDescription.className = 'product-description'; // Add the 'product-description' class to the productDescription
                        productDiv.appendChild(productDescription);

                        var priceButtonWrapper = document.createElement('div'); // Add this to create the wrapper div
                        priceButtonWrapper.className = 'price-button-wrapper';

                        var productPrice = document.createElement('p'); // Add this to create the product price
                        productPrice.textContent = '$' + product.price;
                        productPrice.id = 'product-price';
                        productPrice.className = 'product-price'; // Add the 'product-price' class to the productPrice
                        productDiv.appendChild(productPrice);

                        var addToCartButton = document.createElement('button'); // Add this to create the "Add to Cart" button
                        addToCartButton.textContent = 'Add to Cart';
                        addToCartButton.className = 'myButton'; // Add the 'btn' class to the addToCartButton
                        addToCartButton.addEventListener('click', function () {
                            addToCart(product);
                            alert('Added one item to cart!');
                        });
                        productDiv.appendChild(addToCartButton);

                        productsSection.appendChild(productDiv);
                    }

                    // Add event listener to the search form
                    var searchForm = document.getElementById('searchForm');
                    if (searchForm) {
                        searchForm.addEventListener('submit', function (event) {
                            event.preventDefault(); // Prevent the form from being submitted
                            var query = document.getElementById('searchInput').value;
                            search(query);
                        });
                    }

                    function search(query) {
                        const filteredProducts = products.filter(product =>
                            product.category.toLowerCase().includes(query.toLowerCase()) ||
                            product.name.toLowerCase().includes(query.toLowerCase())
                        );
                        updateProductList(filteredProducts);
                    }
                </script>
            </div>
        </div>
    </main>
    <footer>
        <table>
            <tr>
                <td class="p-footer-color">
                    <p>Â©2023 TD-Shop</p>
                </td>
            </tr>
        </table>
    </footer>
</body>

</html>